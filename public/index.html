<!DOCTYPE HTML>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<title></title>
</head>
<body>

<div id="page"></div>

<form data-type="logout">
	<button>Logout</button>
</form>

<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script type="text/javascript" src="/dpd.js"></script>

<script>
	
	// autologin if player session exists
	dpd.players.me(function(result, errors) {
		if (result !== '') {
			handleSubmission('login', 'me', result, errors);
		} else {
			handleSubmission('home', 'login', result, errors);
		}
	});

	function handleSubmission(type, page, result, error) {
		 if(error) return console.log(error);
		 $('#page').load(page + '.html', function () {
		 	$(document).trigger('/players/' + type + 'ed');
		 });
	}

	$('body').on('submit', 'form', function (e) {
		e.preventDefault();

		var $form = $(this),
			type = $form.data('type'),
			data = ($form.serialize() !== '' ? JSON.parse('{"' + $form.serialize().split('=').join('": "').split('&').join('", "') + '"}') : '');

		switch (type) {

			case 'register':
				dpd.players.post(data, function(result, error) {
					handleSubmission(type, 'login', result, error);
				});
			break;

			case 'login':
				dpd.players.login(data, function(result, error) {
					handleSubmission(type, 'me', result, error);
				});
			break;

			case 'logout':
				dpd.players.logout(function(result, error) {
					handleSubmission(type, 'login', result, error);
				});
			break;

		}

	});

	$(document).bind('/players/registered', function () {
		$('#page').find('form[data-type="login"]').prepend('Now login sucker!');
	});

	$(document).bind('/players/logined', function () {
		dpd.players.me(function(result, errors) {
			$('#page').append(result.username);
		});
	});

	$(document).bind('/players/logouted', function () {
		$('#page').append('Logged out!');
	});

</script>

</body>
</html>